<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phira谱面背景图片保存器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 1em;
            opacity: 0.9;
        }
        
        .input-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input[type="number"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .result-section {
            padding: 20px;
            text-align: center;
        }
        
        .loading {
            display: none;
            color: #666;
            margin: 20px 0;
        }
        
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            display: none;
            background: #ffe6e6;
            color: #d63384;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #d63384;
        }
        
        .success {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        
        .image-container {
            display: none;
            margin: 15px 0;
        }
        
        #chartCanvas {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .save-btn {
            display: none;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 15px 0;
        }
        
        .save-btn:active {
            transform: scale(0.98);
        }
        
        .info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: left;
            font-size: 14px;
            color: #666;
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 12px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        .instructions {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: left;
            font-size: 14px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎵 Phira谱面图片保存器</h1>
            <p>输入ID → 获取图片 → 一键保存到相册</p>
        </div>
        
        <div class="input-section">
            <div class="input-group">
                <input type="number" id="chartId" placeholder="输入谱面ID（如：12238）" min="1">
                <button onclick="getChartImage()">获取图片</button>
            </div>
        </div>
        
        <div class="result-section">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                加载中...
            </div>
            
            <div class="error" id="error"></div>
            <div class="success" id="success"></div>
            
            <div class="image-container" id="imageContainer">
                <canvas id="chartCanvas"></canvas>
                <button class="save-btn" onclick="saveToGallery()">
                    💾 保存到相册
                </button>
                
                <div class="instructions">
                    <strong>💡 保存说明：</strong><br>
                    1. 点击"保存到相册"按钮<br>
                    2. 图片将自动下载到您的设备<br>
                    3. 下载后请到相册或文件管理器中查看
                </div>
                
                <div class="info">
                    <strong>📁 文件位置提示：</strong><br>
                    - 手机：通常在"下载"文件夹或"相册"中<br>
                    - 电脑：通常在"下载"文件夹中
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>专为浏览器优化 | 保证保存成功率</p>
        </div>
    </div>

    <script>
        let currentImage = null;
        let chartData = null;

        // 添加重试功能
        async function fetchWithRetry(url, options = {}, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    throw new Error(`HTTP错误: ${response.status}`);
                } catch (error) {
                    if (i === retries - 1) throw error;
                    // 等待一段时间后重试
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
        }

        async function getChartImage() {
            const chartId = document.getElementById('chartId').value.trim();
            
            if (!chartId) {
                showError('请输入谱面ID');
                return;
            }
            
            showLoading(true);
            hideError();
            hideSuccess();
            hideImage();
            
            try {
                // 获取谱面信息
                const response = await fetchWithRetry(`https://phira.5wyxi.com/chart/${chartId}`);
                
                if (!response.ok) {
                    throw new Error('谱面不存在或网络错误');
                }
                
                chartData = await response.json();
                
                if (!chartData.illustration) {
                    throw new Error('该谱面没有背景图片');
                }
                
                // 加载图片
                const img = new Image();
                img.crossOrigin = "Anonymous"; // 解决跨域问题
                img.src = chartData.illustration + '?t=' + new Date().getTime(); // 添加时间戳避免缓存
                
                img.onload = function() {
                    currentImage = img;
                    
                    // 绘制到Canvas
                    const canvas = document.getElementById('chartCanvas');
                    const ctx = canvas.getContext('2d');
                    
                    // 设置Canvas大小
                    const maxWidth = 800;
                    const maxHeight = 600;
                    let width = img.width;
                    let height = img.height;
                    
                    // 保持宽高比调整大小
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width = (maxHeight / height) * width;
                        height = maxHeight;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // 绘制图片
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    showLoading(false);
                    showImage();
                    showSuccess('图片加载成功！点击下方按钮保存到相册');
                };
                
                img.onerror = function() {
                    throw new Error('图片加载失败，请检查ID是否正确');
                };
                
            } catch (error) {
                showLoading(false);
                showError('获取失败: ' + error.message);
            }
        }

        function saveToGallery() {
            if (!currentImage) {
                showError('请先获取图片');
                return;
            }
            
            try {
                const canvas = document.getElementById('chartCanvas');
                
                // 将Canvas转换为Data URL
                const imageData = canvas.toDataURL('image/jpeg', 0.9);
                
                // 创建下载链接
                const link = document.createElement('a');
                link.href = imageData;
                
                // 生成文件名
                const chartName = chartData?.name ? 
                    chartData.name.replace(/[^\w\u4e00-\u9fa5]/g, '_') : 'phira_chart';
                link.download = `${chartName}_${chartData?.id || Date.now()}.jpg`;
                
                // 模拟点击下载
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess('✅ 保存成功！请检查相册或下载文件夹');
                
            } catch (error) {
                showError('保存失败: ' + error.message);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success').style.display = 'none';
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }
        
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }
        
        function hideSuccess() {
            document.getElementById('success').style.display = 'none';
        }
        
        function showImage() {
            document.getElementById('imageContainer').style.display = 'block';
            document.querySelector('.save-btn').style.display = 'block';
        }
        
        function hideImage() {
            document.getElementById('imageContainer').style.display = 'none';
            document.querySelector('.save-btn').style.display = 'none';
        }
        
        // 支持按Enter键
        document.getElementById('chartId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                getChartImage();
            }
        });
        
        // 页面加载时聚焦输入框
        window.onload = function() {
            document.getElementById('chartId').focus();
        };
    </script>
</body>
</html>