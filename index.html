<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP4视频倒放器</title>
    <style>
        body {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .btn {
            padding: 12px 24px;
            margin: 10px;
            border: none;
            border-radius: 6px;
            background: #2c3e50;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background: #34495e;
        }
        #videoContainer {
            margin: 20px 0;
            display: none;
        }
        video {
            width: 100%;
            max-width: 600px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        #downloads {
            margin: 20px 0;
            display: none;
        }
        .loading {
            margin: 20px 0;
            color: #666;
            display: none;
        }
    </style>
</head>
<body>
    <h1>MP4视频倒放器</h1>
    <input type="file" id="videoInput" accept="video/mp4" style="display: none;" />
    <button class="btn" id="selectBtn">1. 选取本地MP4视频</button>
    <button class="btn" id="reverseBtn" disabled>2. 开始倒放处理</button>
    
    <div class="loading" id="loading">处理中... 视频较大时可能需要几分钟，请耐心等待</div>
    
    <div id="videoContainer">
        <h3>倒放后预览</h3>
        <video id="reverseVideo" controls></video>
    </div>
    
    <div id="downloads">
        <h3>下载选项</h3>
        <button class="btn" id="downloadVideo">下载倒放视频（仅画面）</button>
        <button class="btn" id="downloadAudio">下载倒放音频（仅声音）</button>
        <button class="btn" id="downloadFull">下载完整倒放视频（音画合一）</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script>
        // 初始化FFmpeg
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: false });
        let videoFile = null;

        // DOM元素
        const selectBtn = document.getElementById('selectBtn');
        const reverseBtn = document.getElementById('reverseBtn');
        const videoInput = document.getElementById('videoInput');
        const loading = document.getElementById('loading');
        const videoContainer = document.getElementById('videoContainer');
        const reverseVideo = document.getElementById('reverseVideo');
        const downloads = document.getElementById('downloads');
        const downloadVideo = document.getElementById('downloadVideo');
        const downloadAudio = document.getElementById('downloadAudio');
        const downloadFull = document.getElementById('downloadFull');

        // 1. 选择视频文件
        selectBtn.addEventListener('click', () => {
            videoInput.click();
        });

        videoInput.addEventListener('change', (e) => {
            if (e.target.files.length === 0) return;
            videoFile = e.target.files[0];
            if (videoFile.type !== 'video/mp4') {
                alert('请选择MP4格式的视频文件！');
                videoFile = null;
                return;
            }
            reverseBtn.disabled = false;
            alert(`已选择视频：${videoFile.name}\n大小：${(videoFile.size / 1024 / 1024).toFixed(2)}MB`);
        });

        // 2. 倒放处理（核心逻辑）
        reverseBtn.addEventListener('click', async () => {
            if (!videoFile) return;
            loading.style.display = 'block';
            reverseBtn.disabled = true;
            videoContainer.style.display = 'none';
            downloads.style.display = 'none';

            try {
                // 加载FFmpeg核心
                if (!ffmpeg.isLoaded()) {
                    await ffmpeg.load();
                }

                // 1. 读取本地视频文件
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(videoFile));

                // 2. 分离视频流并倒放（无音频）
                await ffmpeg.run(
                    '-i', 'input.mp4', 
                    '-vf', 'reverse', 
                    '-an', 'reverse_video.mp4'
                );

                // 3. 分离音频流并倒放（无视频）
                await ffmpeg.run(
                    '-i', 'input.mp4', 
                    '-vn', '-af', 'areverse', 
                    'reverse_audio.mp3'
                );

                // 4. 合并倒放视频和音频
                await ffmpeg.run(
                    '-i', 'reverse_video.mp4', 
                    '-i', 'reverse_audio.mp3', 
                    '-c:v', 'copy', 
                    '-c:a', 'aac', 
                    'reverse_full.mp4'
                );

                // 显示结果和下载按钮
                const videoUrl = URL.createObjectURL(new Blob([ffmpeg.FS('readFile', 'reverse_full.mp4')], { type: 'video/mp4' }));
                reverseVideo.src = videoUrl;
                videoContainer.style.display = 'block';
                downloads.style.display = 'block';

            } catch (err) {
                alert('处理失败！请尝试更换较小的MP4文件或刷新页面重试。');
                console.error(err);
            } finally {
                loading.style.display = 'none';
            }
        });

        // 3. 下载功能
        // 下载仅视频
        downloadVideo.addEventListener('click', () => {
            const videoData = ffmpeg.FS('readFile', 'reverse_video.mp4');
            downloadFile(videoData, `${videoFile.name.replace('.mp4', '_倒放_仅视频.mp4')}`, 'video/mp4');
        });

        // 下载仅音频
        downloadAudio.addEventListener('click', () => {
            const audioData = ffmpeg.FS('readFile', 'reverse_audio.mp3');
            downloadFile(audioData, `${videoFile.name.replace('.mp4', '_倒放_仅音频.mp3')}`, 'audio/mpeg');
        });

        // 下载完整音视频
        downloadFull.addEventListener('click', () => {
            const fullData = ffmpeg.FS('readFile', 'reverse_full.mp4');
            downloadFile(fullData, `${videoFile.name.replace('.mp4', '_倒放_完整视频.mp4')}`, 'video/mp4');
        });

        // 通用下载工具函数
        function downloadFile(data, fileName, mimeType) {
            const url = URL.createObjectURL(new Blob([data], { type: mimeType }));
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
